---
description: This rule encourages the AI to check the AI provider's AI implementation.
globs: lib/server/ai-providers/anthropic/*
alwaysApply: false
---
## Instructions for AI Agent

When working with the Anthropic AI provider directory (`lib/server/ai-providers/anthropic/`), you MUST:

### 1. Check Official Documentation First
- Always reference the official Anthropic API documentation at: https://docs.anthropic.com/en/api
- Verify current API endpoints, parameters, and response formats
- Check for any recent API changes, deprecations, or new Claude model releases
- Review Anthropic's API changelog and model updates

### 2. Validate API Endpoint Coverage
- Ensure all implemented endpoints match the official Anthropic API specification
- Verify HTTP methods, request/response schemas, and parameter requirements
- Check that error handling follows Anthropic's documented error responses (400, 401, 403, 429, 500, 529)
- Implement proper handling for Anthropic's specific error codes and rate limit headers

### 3. Review Implementation Patterns
- Confirm request/response type definitions align with Anthropic's official schemas
- Validate authentication mechanisms (x-api-key header with API key)
- Ensure rate limiting and retry logic follows Anthropic's guidelines (respect retry-after headers)
- Implement proper timeout handling and connection management

### 4. Security Best Practices
- Never log or expose API keys in plaintext
- Use environment variables or secure storage for API key management
- Implement proper input validation and sanitization
- Follow Anthropic's usage policies and safety guidelines
- Validate all user inputs before sending to the API
- Be aware of Anthropic's content filtering and safety measures

### 5. Check for Missing Features
- Compare implemented functionality against the full Anthropic API surface:
  - Messages API (primary interface for Claude)
  - Legacy Text Completions API (if still needed)
  - Tool use/function calling capabilities
  - Vision capabilities (image analysis)
  - Document analysis features
- Verify streaming implementation matches Anthropic's Server-Sent Events specification
- Check support for latest Claude models (Claude-3, Claude-3.5, etc.)

### 6. Validate Configuration
- Ensure model names match Anthropic's current model naming conventions (claude-3-*)
- Check default values align with Anthropic's documented defaults
- Validate token limits and context windows for each Claude model
- Implement proper model availability and capability checks
- Handle anthropic-version header correctly

## Provider-Specific Considerations
- **Models**: Keep updated with latest Claude-3 family models and their capabilities
- **Messages Format**: Use Anthropic's specific message format (role: user/assistant)
- **System Messages**: Handle system prompts correctly in the messages structure
- **Tool Use**: Implement Anthropic's tool use format and response handling
- **Vision**: Support image inputs and vision capabilities for supported models
- **Streaming**: Implement Server-Sent Events with proper delta handling
- **Safety**: Respect Anthropic's built-in safety measures and content policies

## Before Making Changes to Anthropic Provider
- Consult https://docs.anthropic.com/en/api for the latest specification
- Cross-reference with existing implementation in `lib/server/ai-providers/anthropic/`
- Test with Anthropic's console or official examples
- Ensure changes maintain backward compatibility where possible
- Update type definitions to match any API schema changes
- Review Claude's capabilities and limitations for each model

## Files to Review
- All files under `lib/server/ai-providers/anthropic/`
- Related type definitions in `lib/shared/types/`
- Anthropic-specific configurations, constants, and model definitions
- Authentication and error handling utilities
- Message formatting and tool use implementations

**Note:** This rule ensures the Anthropic provider implementation stays current with the official Claude API specification, follows security best practices, and properly handles Claude's unique features like tool use and vision capabilities.
